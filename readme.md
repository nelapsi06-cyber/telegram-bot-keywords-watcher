### Общая информация

Данный скрипт позволяет прослушивать все сообщения, приходящие в инбокс некоторому телеграм-пользователю, искать в нём ключевые слова или фразы, и при нахождении отправлять их в указанный чат от имени бота.

### Инсталляция и запуск

Для работы Node.js (проверено на версии 20) и npm
Перейти в директорию с проектом и выполнить:
```
npm install
```

#### Подготовка .env-файла

Основные настройки скрипта должны лежать в файле `.env` в корне проекта. Файл должен быть следующего содержания:

```
API_ID=100
API_HASH=100
BOT_TOKEN=100
PHONE_NUMBER=+79999999999
KEYPHRASES=межпозвонковая грыжа,спина,ищу невролога
TARGET_CHAT_ID=100
```

* `API_ID` - идентификатор telegram-приложения (см. ниже)
* `API_HASH` - хеш telegram-приложения
* `BOT_TOKEN` - токен бота, который будет отправлять сообщения (см. ниже)
* `PHONE_NUMBER` - номер телефона пользователя, который будет использоваться для авторизации в telegram. Рекомендуется использовать отдельный аккаунт.
* `KEYPHRASES` - ключевые фразы, которые будут искаться в сообщениях (см. ниже)
* `TARGET_CHAT_ID` - ID telegram-чата, в который будут отправляться сообщения от имени бота (см. ниже)

##### Получение API_ID и API_HASH

Для получения API_ID и API_HASH нужно зарегистрироваться в [my.telegram.org](https://my.telegram.org) и создать новое приложение.

##### Получение BOT_TOKEN

Также можно создать нового бота в [@BotFather](https://t.me/botfather) и получить токен.
В любом случае необходимо убедиться, что бот добавлен в целевой чат.

##### Получение TARGET_CHAT_ID

Например, через ещё одного бота @getidsbot.
Также можно увидеть ID чата в URL через Telegram Web.

#### Запуск

```
npm start
```

При первом запуске будет выполнена авторизация в telegram. Потребуется ввести пароль и одноразовый код, который придёт в телеграм на указанный номер.
После этого будет сохранена сессия (в папку `saved_sessions`), последующий запуск будет происходить без авторизации.
Запущенный скрипт работает обрабатывает все входящие сообщения для указанного пользователя и завершает работу при нажатии Ctrl+C либо закрытии окна терминала \ разрыве SSH-соединения.


### Поиск ключевых фраз

Ключевые фразы указываются в файле `.env` в переменной `KEYPHRASES`. Каждая ключевая фраза должна быть отделена запятой и может состоять из одного или нескольких слов.
Для поиска ключевых фраз используется библиотека [natural](https://www.npmjs.com/package/natural). Как сообщения, так и фразы нормализуются, токенизируются (убираются окончания и пр.), после чего происходит поиск ключевых фраз в сообщении. Порядок слов из фразы не имеет значения. Сообщения, содержащие фразы с указанной степенью достоверности, отправляются от имени бота в целевой чат. Для того, чтобы протестировать поиск указанных ключевых фраз, можно выполнить команду:
```
npm run test
```
Пример вывода:
```
> node ./keyphrase-matcher-test.js

using KEYPHRASES: межпозвонковая грыжа,спина,ищу невролога
for "ищу хорошего невролога в москве" found next matches: ищу невролога (1.00)
for "посоветуйте пожалуйста грамотного эндокринолога" no matches found
for "нужен опытный кардиолог, срочно" no matches found
for "где найти детского ортопеда в центре?" no matches found
for "ищу проверенного гастроэнтеролога по отзывам" no matches found
for "помогите найти врача от боли в спине" found next matches: спина (1.00)
for "нужна консультация терапевта" no matches found
for "кто знает нормального лора недорого?" no matches found
for "посоветуйте педиатра в районе сокольников" no matches found
for "ищу специалиста по щитовидке" no matches found
for "может кто-то порекомендовать хорошего гинеколога" no matches found
for "нужен грамотный дерматолог, не из частной клиники" no matches found
for "ищу мануального терапевта с опытом" no matches found
for "кто может посоветовать психотерапевта?" no matches found
for "нужен стоматолог, который работает с детьми" no matches found
for "болит спина, МРТ показало грыжу в пояснице" found next matches: спина (1.00)
for "ищу хорошего врача, диагностировали межпозвонковую грыжу л4-л5" found next matches: межпозвонковая грыжа (1.00)
for "помогите, у меня межпозвоночная грыжа в шейном отделе" found next matches: межпозвонковая грыжа (0.86)
for "кто лечил грыжу позвоночника без операции?" no matches found
for "посоветуйте специалиста по межпозвонковым грыжам" found next matches: межпозвонковая грыжа (1.00)
for "грыжа в спине 7мм, какое лечение посоветуете?" found next matches: спина (1.00)
for "ищу невролога, который лечит межпозвоночные грыжи" found next matches: ищу невролога (1.00), межпозвонковая грыжа (0.86)
for "где делают блокады при межпозвонковой грыже?" found next matches: межпозвонковая грыжа (1.00)
for "невролог от грыжи в пояснице срочно нужен" no matches found
for "посоветуйте упражнения при межпозвоночной грыже" found next matches: межпозвонковая грыжа (0.86)
for "грыжа диска l5s1, какой метод лечения выбрать?" no matches found
for "грыжы диска l5s1, какой метод лечения выбрать?" no matches found
for "межпозвонковая грыжа 9мм, помогите советом" found next matches: межпозвонковая грыжа (1.00)
for "ищу мануального терапевта с опытом лечения грыж" no matches found
for "порекомендуйте клинику для лечения межпозвонковой грыжи" found next matches: межпозвонковая грыжа (1.00)
for "боль в спине из-за грыжи, какой врач нужен?" found next matches: спина (1.00)
for "межпозвонковая грыжа" found next matches: межпозвонковая грыжа (1.00)
for "где специалист по грыжам?" no matches found
```

Вместе с пересылаемым сообщением отправляется также найденная ключевая фраза и степень достоверности. Пример:
```
Keyword found: межпозвонковая грыжа (1.000)
Username: @trevojnost
Full user name: Nikolay
Message link: Find message (https://t.me/testtttt1group/82)
Channel/Group title: test
Channel/Group link: https://t.me/testtttt1group

Telegram (https://t.me/testtttt1group/82)
Nikolay in test
порекомендуйте клинику для лечения межпозвонковой грыжи
```

### Прочая информация

На текущий момент слушаются сообщения как из публичных групп, так и каналов. Игнорируются любые сообщения от ботов (в том числе от того, который пересылает сообщения).
